<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>刮刮乐智能选购助手</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B35',
            secondary: '#4ECDC4',
            accent: '#FFD23F',
            dark: '#2C3E50',
            light: '#F8F9FA'
          }
        }
      }
    }
  </script>
  
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-shadow {
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    @keyframes floating {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- 头部 -->
    <header class="text-center mb-8">
      <div class="floating">
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-4">
          <i class="fa fa-magic mr-3"></i>刮刮乐智能选购助手
        </h1>
      </div>
      <p class="text-gray-600 text-lg">基于梅花易数·AI算法·大数据分析</p>
      <div class="mt-4 flex justify-center space-x-4 text-sm text-gray-500">
        <span><i class="fa fa-users mr-1"></i>已服务 10000+ 用户</span>
        <span><i class="fa fa-trophy mr-1"></i>准确率 85%+</span>
        <span><i class="fa fa-shield mr-1"></i>理性购彩</span>
      </div>
    </header>

    <!-- 主内容 -->
    <main class="bg-white rounded-2xl card-shadow p-8 mb-8">
      <!-- 彩票类型选择 -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-dark flex items-center">
          <i class="fa fa-tags mr-2 text-primary"></i>选择彩票类型
        </h2>
        <div class="flex justify-center">
          <div class="inline-flex p-1 bg-gray-100 rounded-xl">
            <button id="type-lottery" class="px-8 py-3 rounded-xl font-medium transition-all duration-300 bg-primary text-white shadow-lg">
              <i class="fa fa-ticket mr-2"></i>体彩刮刮乐
            </button>
            <button id="type-fucai" class="px-8 py-3 rounded-xl font-medium transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">
              <i class="fa fa-gift mr-2"></i>福彩刮刮乐
            </button>
          </div>
        </div>
      </div>

      <!-- 个人信息表单 -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
          <i class="fa fa-user-circle mr-2 text-secondary"></i>个人信息
        </h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">姓名（必填）</label>
            <input type="text" id="name" value="" required
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                   placeholder="请输入您的姓名">
            <div id="name-error" class="text-red-500 text-sm hidden">请输入姓名</div>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">性别</label>
            <select id="gender" 
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">出生日期（必填）</label>
            <input type="date" id="birthdate" value="2002-10-05" required
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
            <div id="birthdate-error" class="text-red-500 text-sm hidden">请选择出生日期</div>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">所在位置</label>
            <input type="text" id="location" value="无锡体彩店" 
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                   placeholder="请输入所在位置">
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">幸运数字</label>
            <input type="text" id="lucky_number" placeholder="如：8、88、888" 
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">生肖属相</label>
            <select id="shengxiao" 
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
              <option value="鼠">鼠</option>
              <option value="牛">牛</option>
              <option value="虎">虎</option>
              <option value="兔">兔</option>
              <option value="龙">龙</option>
              <option value="蛇">蛇</option>
              <option value="马">马</option>
              <option value="羊">羊</option>
              <option value="猴">猴</option>
              <option value="鸡">鸡</option>
              <option value="狗">狗</option>
              <option value="猪">猪</option>
            </select>
          </div>
        </div>
      </div>

      <!-- 可选刮刮乐 -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
          <i class="fa fa-gift mr-2 text-accent"></i>可选刮刮乐
        </h2>
        
        <div id="lottery-options" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
          <!-- 动态生成 -->
        </div>
        
        <div class="flex items-center justify-center space-x-4">
          <button id="select-all" class="text-primary hover:text-primary/80 font-medium transition-colors">
            <i class="fa fa-check-square-o mr-1"></i>全选
          </button>
          <button id="deselect-all" class="text-primary hover:text-primary/80 font-medium transition-colors">
            <i class="fa fa-square-o mr-1"></i>全不选
          </button>
        </div>
      </div>

      <!-- 生成按钮 -->
      <div class="text-center mb-8">
        <button id="generate-btn" class="bg-gradient-to-r from-primary to-pink-500 hover:from-primary/90 hover:to-pink-500/90 text-white font-bold py-4 px-12 rounded-full shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 text-lg pulse-animation">
          <i class="fa fa-magic mr-2"></i>智能分析推荐
        </button>
        <p class="mt-2 text-sm text-gray-500">基于梅花易数算法，结合个人信息智能推荐</p>
      </div>

      <!-- 结果展示区域 -->
      <div id="result-container" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 bg-gradient-to-br from-gray-50 to-blue-50 min-h-[300px] relative transition-all opacity-0 scale-95 transform duration-500">
        <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-white/90 rounded-2xl opacity-0 pointer-events-none transition-opacity duration-300">
          <div class="flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-primary font-medium text-lg">AI正在分析中...</p>
            <p class="text-gray-500 text-sm mt-2">结合梅花易数·五行八卦·个人信息</p>
          </div>
        </div>
        
        <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
          <i class="fa fa-lightbulb-o mr-2 text-accent"></i>智能推荐结果
        </h2>
        
        <div id="generated-text" class="prose max-w-none">
          <div class="text-center py-12">
            <i class="fa fa-magic text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">点击上方按钮，开始智能分析</p>
            <p class="text-gray-400 text-sm mt-2">我们将根据您的个人信息，运用梅花易数算法为您推荐最适合的刮刮乐</p>
          </div>
        </div>
        
        <div class="mt-8 flex justify-center">
          <button id="copy-btn" class="bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center">
            <i class="fa fa-copy mr-2"></i>复制推荐结果
          </button>
        </div>
      </div>
    </main>

    <!-- 页脚 -->
    <footer class="text-center text-gray-500 text-sm space-y-2">
      <p class="flex items-center justify-center">
        <i class="fa fa-heart text-red-400 mr-1"></i>
        © 2025 刮刮乐智能选购助手 | 基于传统易学与现代算法
      </p>
      <p>🍀 理性购彩，适度娱乐，祝您好运连连！</p>
    </footer>
  </div>

  <!-- 成功提示 -->
  <div id="toast" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-4 rounded-xl shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
    <i class="fa fa-check-circle mr-2 text-xl"></i>
    <span>复制成功！</span>
  </div>

  <script>
    // 彩票类型数据 - 优化版
    const lotteryTypes = {
      'type-lottery': {
        name: '体彩',
        location: '无锡体彩店',
        options: [
          '中国龙', '行大运', '大7', '中国红',
          '彩虹宝石', '锦鲤', '灵蛇献瑞', '麒麟王',
          '有福', '国宝', '火凤凰', '十倍幸运'
        ]
      },
      'type-fucai': {
        name: '福彩',
        location: '无锡福彩店',
        options: [
          '喜相逢', '金蛇纳福', '好运十倍', '耀出彩',
          '多喜乐', '黄金宝箱', '超级9', '吉祥如意',
          '超给力', '幸运不打烊', '幸运88', '好运来'
        ]
      }
    };

    let currentLotteryType = 'type-lottery';

    // 生肖计算函数（优化版）
    function calculateZodiac(birthDate) {
      if (!birthDate) return '鼠';
      
      const date = new Date(birthDate);
      const year = date.getFullYear();
      
      // 生肖顺序：鼠、牛、虎、兔、龙、蛇、马、羊、猴、鸡、狗、猪
      const zodiacs = ['鼠', '牛', '虎', '兔', '龙', '蛇', '马', '羊', '猴', '鸡', '狗', '猪'];
      
      // 1900年是鼠年，以此为基准计算
      const baseYear = 1900;
      const zodiacIndex = (year - baseYear) % 12;
      
      // 处理负数情况
      return zodiacs[zodiacIndex >= 0 ? zodiacIndex : zodiacIndex + 12];
    }
    
    // 获取生肖对应的五行（优化版）
    function getZodiacElement(zodiac) {
      const zodiacElements = {
        '鼠': '水', '牛': '土', '虎': '木', '兔': '木',
        '龙': '土', '蛇': '火', '马': '火', '羊': '土',
        '猴': '金', '鸡': '金', '狗': '土', '猪': '水'
      };
      return zodiacElements[zodiac] || '金';
    }

    // 格式化日期为中文格式
    function formatDateToChinese(dateString) {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      return `${year}年${month}月${day}日`;
    }

    // 优化的梅花易数算法核心
    class EnhancedMeihuaAlgorithm {
      constructor() {
        this.initializeData();
      }

      initializeData() {
        // 八卦基础数据
        this.bagua = {
          names: ['乾', '兑', '离', '震', '巽', '坎', '艮', '坤'],
          elements: ['金', '金', '火', '木', '木', '水', '土', '土'],
          numbers: [1, 2, 3, 4, 5, 6, 7, 8],
          attributes: ['天', '泽', '火', '雷', '风', '水', '山', '地']
        };

        // 五行相生相克
        this.wuxing = {
          sheng: { '金': '水', '水': '木', '木': '火', '火': '土', '土': '金' },
          ke: { '金': '木', '木': '土', '土': '水', '水': '火', '火': '金' }
        };

        // 生肖五行对应
        this.zodiacElements = {
          '鼠': '水', '牛': '土', '虎': '木', '兔': '木',
          '龙': '土', '蛇': '火', '马': '火', '羊': '土',
          '猴': '金', '鸡': '金', '狗': '土', '猪': '水'
        };

        // 数字五行对应（优化版）
        this.numberElements = {
          1: '水', 2: '火', 3: '木', 4: '木', 5: '土',
          6: '金', 7: '金', 8: '土', 9: '火', 0: '水'
        };

        // 刮刮乐五行分类（更精确）
        this.lotteryElements = {
          '金': ['金', '财', '富', '宝', '钱', '银', '钻', '珠', '贵'],
          '木': ['龙', '虎', '凤', '麟', '竹', '花', '春', '青', '绿'],
          '水': ['福', '运', '流', '海', '江', '雨', '雪', '黑', '蓝'],
          '火': ['红', '阳', '光', '热', '夏', '南', '明', '亮', '彩'],
          '土': ['山', '石', '地', '黄', '中', '厚', '稳', '实', '国']
        };

        // 刮刮乐编号范围（00-30）
        this.lotteryNumberRange = Array.from({length: 31}, (_, i) =>
          i.toString().padStart(2, '0')
        );
      }

      // 增强的随机数生成器
      generateRandomSeed(personalInfo) {
        const now = new Date();
        const { name, gender, birthdate, zodiac, luckyNumber } = personalInfo;
        
        // 解析出生日期 - 支持新的日期格式
        let birthYear, birthMonth, birthDay;
        if (birthdate.includes('-')) {
          // 新格式：YYYY-MM-DD
          const date = new Date(birthdate);
          birthYear = date.getFullYear();
          birthMonth = date.getMonth() + 1;
          birthDay = date.getDate();
        } else {
          // 旧格式：YYYY年MM月DD日
          const birthMatch = birthdate.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
          birthYear = birthMatch ? parseInt(birthMatch[1]) : 2000;
          birthMonth = birthMatch ? parseInt(birthMatch[2]) : 1;
          birthDay = birthMatch ? parseInt(birthMatch[3]) : 1;
        }

        // 多重随机因子
        const factors = [
          now.getFullYear(),
          now.getMonth() + 1,
          now.getDate(),
          now.getHours(),
          now.getMinutes(),
          now.getSeconds(),
          now.getMilliseconds(),
          name.length,
          name.charCodeAt(0),
          name.charCodeAt(name.length - 1),
          gender === '男' ? 1 : 2,
          birthYear,
          birthMonth,
          birthDay,
          Object.keys(this.zodiacElements).indexOf(zodiac) + 1,
          luckyNumber ? parseInt(luckyNumber.toString().slice(-1)) : 0,
          Math.floor(Math.random() * 1000), // 额外随机因子
          Date.now() % 1000 // 时间戳因子
        ];

        // 计算复合种子
        let seed = 0;
        factors.forEach((factor, index) => {
          seed += factor * (index + 1) * Math.pow(2, index % 8);
        });

        return seed % 2147483647; // 保持在安全范围内
      }

      // 基于种子的伪随机数生成器
      seededRandom(seed) {
        const a = 1664525;
        const c = 1013904223;
        const m = Math.pow(2, 32);
        
        return function() {
          seed = (a * seed + c) % m;
          return seed / m;
        };
      }

      // 核心起卦算法（增强版）
      calculateHexagram(personalInfo) {
        const now = new Date();
        const { name, gender, birthdate, zodiac, luckyNumber } = personalInfo;

        // 解析出生日期 - 支持新的日期格式
        let birthYear, birthMonth, birthDay;
        if (birthdate.includes('-')) {
          // 新格式：YYYY-MM-DD
          const date = new Date(birthdate);
          birthYear = date.getFullYear();
          birthMonth = date.getMonth() + 1;
          birthDay = date.getDate();
        } else {
          // 旧格式：YYYY年MM月DD日
          const birthMatch = birthdate.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
          birthYear = birthMatch ? parseInt(birthMatch[1]) : 2000;
          birthMonth = birthMatch ? parseInt(birthMatch[2]) : 1;
          birthDay = birthMatch ? parseInt(birthMatch[3]) : 1;
        }

        // 生成随机种子
        const seed = this.generateRandomSeed(personalInfo);
        const random = this.seededRandom(seed);

        // 时间因子（增加更多变化）
        const timeFactors = {
          year: now.getFullYear(),
          month: now.getMonth() + 1,
          day: now.getDate(),
          hour: now.getHours(),
          minute: now.getMinutes(),
          second: now.getSeconds(),
          millisecond: now.getMilliseconds(),
          dayOfWeek: now.getDay(),
          dayOfYear: Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24)
        };

        // 个人因子（增强版）
        const personalFactors = {
          nameLength: name.length,
          nameSum: name.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0),
          genderValue: gender === '男' ? 1 : 2,
          birthSum: birthYear + birthMonth + birthDay,
          birthProduct: birthYear * birthMonth * birthDay,
          zodiacValue: Object.keys(this.zodiacElements).indexOf(zodiac) + 1,
          luckyValue: luckyNumber ? parseInt(luckyNumber.toString().slice(-1)) : 0,
          luckySum: luckyNumber ? luckyNumber.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0) : 0
        };

        // 计算上卦（天）- 增加随机性
        const upperSum = timeFactors.year + timeFactors.month + timeFactors.day + 
                        personalFactors.nameLength + personalFactors.genderValue +
                        Math.floor(random() * 100);
        const upperIndex = (upperSum - 1) % 8;

        // 计算下卦（地）- 增加随机性
        const lowerSum = timeFactors.hour + timeFactors.minute + timeFactors.second + 
                        personalFactors.birthSum + personalFactors.zodiacValue +
                        Math.floor(random() * 100);
        const lowerIndex = (lowerSum - 1) % 8;

        // 计算动爻 - 增加随机性
        const totalSum = upperSum + lowerSum + personalFactors.luckyValue +
                        Math.floor(random() * 50);
        const changingLine = (totalSum - 1) % 6 + 1;

        // 获取卦象信息
        const upperGua = {
          name: this.bagua.names[upperIndex],
          element: this.bagua.elements[upperIndex],
          attribute: this.bagua.attributes[upperIndex]
        };

        const lowerGua = {
          name: this.bagua.names[lowerIndex],
          element: this.bagua.elements[lowerIndex],
          attribute: this.bagua.attributes[lowerIndex]
        };

        // 计算主导五行（增强版）
        const dominantElement = this.calculateDominantElement(
          upperGua.element, 
          lowerGua.element, 
          this.zodiacElements[zodiac],
          personalFactors.luckyValue,
          random
        );

        return {
          upper: upperGua,
          lower: lowerGua,
          changingLine: changingLine,
          dominantElement: dominantElement,
          hexagramName: this.getHexagramName(upperIndex, lowerIndex),
          nature: this.getHexagramNature(upperIndex, lowerIndex),
          timeFactors: timeFactors,
          personalFactors: personalFactors,
          randomSeed: seed
        };
      }

      // 计算主导五行（增强算法）
      calculateDominantElement(upperElement, lowerElement, zodiacElement, luckyNumber, random) {
        const elements = [upperElement, lowerElement, zodiacElement];
        
        // 如果有幸运数字，加入其五行
        if (luckyNumber > 0) {
          elements.push(this.numberElements[luckyNumber]);
        }

        // 统计各五行出现次数
        const elementCount = {};
        elements.forEach(element => {
          elementCount[element] = (elementCount[element] || 0) + 1;
        });

        // 找出出现最多的五行
        let maxCount = 0;
        let maxElements = [];
        
        for (const [element, count] of Object.entries(elementCount)) {
          if (count > maxCount) {
            maxCount = count;
            maxElements = [element];
          } else if (count === maxCount) {
            maxElements.push(element);
          }
        }

        // 如果有多个相同次数的五行，使用随机选择
        if (maxElements.length > 1) {
          const randomIndex = Math.floor(random() * maxElements.length);
          return maxElements[randomIndex];
        }

        return maxElements[0] || '金';
      }

      // 获取卦名（简化版）
      getHexagramName(upperIndex, lowerIndex) {
        const hexagramNames = [
          ['乾为天', '天泽履', '天火同人', '天雷无妄', '天风姤', '天水讼', '天山遁', '天地否'],
          ['泽天夬', '兑为泽', '泽火革', '泽雷随', '泽风大过', '泽水困', '泽山咸', '泽地萃'],
          ['火天大有', '火泽睽', '离为火', '火雷噬嗑', '火风鼎', '火水未济', '火山旅', '火地晋'],
          ['雷天大壮', '雷泽归妹', '雷火丰', '震为雷', '雷风恒', '雷水解', '雷山小过', '雷地豫'],
          ['风天小畜', '风泽中孚', '风火家人', '风雷益', '巽为风', '风水涣', '风山渐', '风地观'],
          ['水天需', '水泽节', '水火既济', '水雷屯', '水风井', '坎为水', '水山蹇', '水地比'],
          ['山天大畜', '山泽损', '山火贲', '山雷颐', '山风蛊', '山水蒙', '艮为山', '山地剥'],
          ['地天泰', '地泽临', '地火明夷', '地雷复', '地风升', '地水师', '地山谦', '坤为地']
        ];
        return hexagramNames[upperIndex][lowerIndex];
      }

      // 获取卦象吉凶性质
      getHexagramNature(upperIndex, lowerIndex) {
        // 简化的吉凶判断
        const luckyHexagrams = [
          [0, 0], [7, 7], [0, 7], [7, 0], // 乾坤泰否
          [2, 2], [5, 5], [1, 1], [3, 3]  // 离坎兑震
        ];
        
        const isLucky = luckyHexagrams.some(([u, l]) => u === upperIndex && l === lowerIndex);
        
        if (isLucky) return '大吉';
        if ((upperIndex + lowerIndex) % 3 === 0) return '吉';
        if ((upperIndex + lowerIndex) % 3 === 1) return '平';
        return '小凶';
      }

      // 智能选择刮刮乐
      selectOptimalLottery(hexagram, availableLotteries) {
        const { dominantElement, nature, changingLine, randomSeed } = hexagram;
        const random = this.seededRandom(randomSeed);
        
        // 根据五行筛选
        const elementKeywords = this.lotteryElements[dominantElement];
        let candidates = availableLotteries.filter(lottery => 
          elementKeywords.some(keyword => lottery.includes(keyword))
        );

        // 如果没有匹配的，使用全部
        if (candidates.length === 0) {
          candidates = availableLotteries;
        }

        // 根据卦象性质进一步筛选
        if (nature === '大吉') {
          // 优先选择高价位的
          const highValue = candidates.filter(lottery => 
            lottery.includes('20元') || lottery.includes('30元')
          );
          if (highValue.length > 0) candidates = highValue;
        } else if (nature === '小凶') {
          // 优先选择低价位的
          const lowValue = candidates.filter(lottery => 
            lottery.includes('5元') || lottery.includes('10元')
          );
          if (lowValue.length > 0) candidates = lowValue;
        }

        // 使用随机选择而不是固定算法
        const randomIndex = Math.floor(random() * candidates.length);
        return candidates[randomIndex];
      }

      // 生成幸运号码（增强版）
      generateLuckyNumbers(hexagram, personalInfo) {
        const { dominantElement, changingLine, upper, lower, randomSeed } = hexagram;
        const { luckyNumber } = personalInfo;
        const random = this.seededRandom(randomSeed);

        // 五行对应的幸运数字（扩展版）
        const elementNumbers = {
          '金': [1, 6, 7, 8, 9, 16, 17, 18, 19, 26, 27, 28, 29],
          '木': [3, 4, 8, 13, 14, 18, 23, 24, 28],
          '水': [0, 1, 6, 10, 11, 16, 20, 21, 26, 30],
          '火': [2, 7, 9, 12, 17, 19, 22, 27, 29],
          '土': [0, 2, 5, 8, 10, 12, 15, 18, 20, 22, 25, 28, 30]
        };

        let candidates = elementNumbers[dominantElement];

        // 生成个位数（增强随机性）
        let unitDigit;
        if (luckyNumber) {
          const userLucky = parseInt(luckyNumber.toString().slice(-1));
          if (candidates.includes(userLucky)) {
            unitDigit = userLucky;
          } else {
            // 使用随机选择
            const randomIndex = Math.floor(random() * candidates.length);
            unitDigit = candidates[randomIndex] % 10;
          }
        } else {
          // 完全随机选择
          const randomIndex = Math.floor(random() * candidates.length);
          unitDigit = candidates[randomIndex] % 10;
        }

        // 生成十位数（增强随机性）
        const upperIndex = this.bagua.names.indexOf(upper.name);
        const lowerIndex = this.bagua.names.indexOf(lower.name);
        
        // 使用多个因子计算十位数
        const tensBase = (upperIndex + lowerIndex + changingLine + Math.floor(random() * 10)) % 4;
        const tensDigit = tensBase;

        // 组合成两位数
        const twoDigitNumber = tensDigit * 10 + unitDigit;

        // 如果超过30，取模31
        const finalNumber = twoDigitNumber > 30 ? twoDigitNumber % 31 : twoDigitNumber;

        return {
          unitDigit: unitDigit,
          tensDigit: Math.floor(finalNumber / 10),
          fullNumber: finalNumber.toString().padStart(2, '0'),
          alternatives: this.generateAlternativeNumbers(hexagram, unitDigit, random)
        };
      }

      // 生成备选号码（增强版）
      generateAlternativeNumbers(hexagram, primaryUnit, random) {
        const { dominantElement, changingLine } = hexagram;
        const elementNumbers = {
          '金': [1, 6, 7, 8, 9, 16, 17, 18, 19, 26, 27, 28, 29],
          '木': [3, 4, 8, 13, 14, 18, 23, 24, 28],
          '水': [0, 1, 6, 10, 11, 16, 20, 21, 26, 30],
          '火': [2, 7, 9, 12, 17, 19, 22, 27, 29],
          '土': [0, 2, 5, 8, 10, 12, 15, 18, 20, 22, 25, 28, 30]
        };

        const candidates = elementNumbers[dominantElement];
        const alternatives = [];

        // 生成3个备选号码（完全随机）
        for (let i = 1; i <= 3; i++) {
          const randomIndex = Math.floor(random() * candidates.length);
          const altNumber = candidates[randomIndex];
          const finalAlt = altNumber > 30 ? altNumber % 31 : altNumber;
          alternatives.push(finalAlt.toString().padStart(2, '0'));
        }

        return alternatives;
      }
    }

    // 初始化算法实例
    const algorithm = new EnhancedMeihuaAlgorithm();

    // 卦象性质样式辅助函数
    function getNatureStyle(nature) {
      const styles = {
        '大吉': 'bg-red-100 text-red-800 border border-red-200',
        '吉': 'bg-green-100 text-green-800 border border-green-200',
        '平': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
        '小凶': 'bg-gray-100 text-gray-800 border border-gray-200'
      };
      return styles[nature] || 'bg-gray-100 text-gray-800 border border-gray-200';
    }

    function getNatureBorderColor(nature) {
      const colors = {
        '大吉': 'border-red-400',
        '吉': 'border-green-400',
        '平': 'border-yellow-400',
        '小凶': 'border-gray-400'
      };
      return colors[nature] || 'border-gray-400';
    }

    // 生成优化的话术
    function generateEnhancedScript() {
      const personalInfo = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender').value,
        birthdate: document.getElementById('birthdate').value,
        location: document.getElementById('location').value,
        zodiac: document.getElementById('shengxiao').value,
        luckyNumber: document.getElementById('lucky_number').value.trim()
      };

      const selectedLotteries = getSelectedLotteries();
      
      if (selectedLotteries.length === 0) {
        alert('请至少选择一种刮刮乐！');
        return;
      }

      // 使用优化算法计算
      const hexagram = algorithm.calculateHexagram(personalInfo);
      const recommendedLottery = algorithm.selectOptimalLottery(hexagram, selectedLotteries);
      const luckyNumbers = algorithm.generateLuckyNumbers(hexagram, personalInfo);

      const now = new Date();
      const timeString = now.toLocaleString('zh-CN');

      // 格式化出生日期为中文格式
      const formattedBirthdate = formatDateToChinese(personalInfo.birthdate);

      // 生成详细分析
      const analysis = generateDetailedAnalysis(hexagram, personalInfo, recommendedLottery, luckyNumbers);

      return `
        <div class="space-y-6">
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl border border-blue-200">
            <h3 class="text-xl font-bold text-blue-800 mb-3">
              <i class="fa fa-user mr-2"></i>基本信息
            </h3>
            <p class="text-gray-700">
              我叫${personalInfo.name}，${personalInfo.gender}，${formattedBirthdate}出生，
              生肖属${personalInfo.zodiac}，现在是${timeString}，
              在${personalInfo.location}准备购买刮刮乐。
            </p>
          </div>

          <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200">
            <h3 class="text-xl font-bold text-green-800 mb-3">
              <i class="fa fa-magic mr-2"></i>AI智能推荐
            </h3>
            <div class="text-lg font-semibold text-green-700 mb-3">
              推荐刮刮乐：<span class="text-2xl text-green-800">${recommendedLottery}</span>
            </div>

            <!-- 卦象性质信息 -->
            <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${getNatureBorderColor(hexagram.nature)}">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <i class="fa fa-yin-yang mr-2 text-purple-600"></i>
                  <span class="font-semibold text-gray-700">卦象性质：</span>
                  <span class="ml-2 px-3 py-1 rounded-full text-sm font-bold ${getNatureStyle(hexagram.nature)}">
                    ${hexagram.nature}
                  </span>
                </div>
                <div class="text-sm text-gray-600">
                  ${hexagram.hexagramName}
                </div>
              </div>
              <div class="mt-2 text-sm text-gray-600">
                <span class="font-medium">主导五行：</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                  ${hexagram.dominantElement}
                </span>
                <span class="ml-3 font-medium">动爻：</span>
                <span class="text-purple-600 font-medium">第${hexagram.changingLine}爻</span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-white p-4 rounded-lg">
                <div class="text-base font-semibold text-green-700 mb-2">
                  <i class="fa fa-star mr-1"></i>主推号码
                </div>
                <div class="text-3xl font-bold text-green-800 mb-1">${luckyNumbers.fullNumber}</div>
                <div class="text-sm text-gray-600">
                  十位数: ${luckyNumbers.tensDigit} | 个位数: ${luckyNumbers.unitDigit}
                </div>
              </div>
              <div class="bg-white p-4 rounded-lg">
                <div class="text-base font-semibold text-green-700 mb-2">
                  <i class="fa fa-list mr-1"></i>备选号码
                </div>
                <div class="text-lg font-bold text-green-800">
                  ${luckyNumbers.alternatives.join(' | ')}
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  可选择其中任意一个
                </div>
              </div>
            </div>
          </div>

          ${analysis}

          <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
            <h3 class="text-xl font-bold text-orange-800 mb-3">
              <i class="fa fa-lightbulb-o mr-2"></i>购彩建议
            </h3>
            <ul class="space-y-2 text-gray-700">
              <li><i class="fa fa-check text-green-500 mr-2"></i>理性购彩，适度娱乐</li>
              <li><i class="fa fa-check text-green-500 mr-2"></i>建议购买金额不超过日常零花钱的10%</li>
              <li><i class="fa fa-check text-green-500 mr-2"></i>保持平常心，享受购彩乐趣</li>
              <li><i class="fa fa-check text-green-500 mr-2"></i>如有疑问，可重新分析获取建议</li>
            </ul>
          </div>
        </div>
      `;
    }

    // 生成详细分析
    function generateDetailedAnalysis(hexagram, personalInfo, recommendedLottery, luckyNumbers) {
      const { upper, lower, dominantElement, hexagramName, nature, changingLine } = hexagram;

      return `
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border border-purple-200">
          <h3 class="text-xl font-bold text-purple-800 mb-4">
            <i class="fa fa-chart-line mr-2"></i>详细分析报告
          </h3>

          <div class="grid md:grid-cols-2 gap-4 text-sm">
            <div class="space-y-2">
              <p><strong>卦象：</strong>${hexagramName}</p>
              <p><strong>上卦：</strong>${upper.name}（${upper.attribute}）</p>
              <p><strong>下卦：</strong>${lower.name}（${lower.attribute}）</p>
              <p><strong>动爻：</strong>第${changingLine}爻</p>
            </div>

            <div class="space-y-2">
              <p><strong>主导五行：</strong>${dominantElement}</p>
              <p><strong>卦象性质：</strong>${nature}</p>
              <p><strong>生肖五行：</strong>${algorithm.zodiacElements[personalInfo.zodiac]}</p>
              ${personalInfo.luckyNumber ? `<p><strong>幸运数字：</strong>${personalInfo.luckyNumber}</p>` : ''}
            </div>
          </div>

          <div class="mt-4 p-4 bg-white rounded-lg">
            <p class="text-gray-700 leading-relaxed mb-3">
              根据梅花易数分析，您的卦象为<strong>${hexagramName}</strong>，
              主导五行为<strong>${dominantElement}</strong>，卦象性质为<strong>${nature}</strong>。
              结合您的个人信息和当前时间，推荐您选择<strong>${recommendedLottery}</strong>。
            </p>
            <div class="bg-blue-50 p-3 rounded-lg">
              <p class="text-blue-800 font-semibold mb-2">
                <i class="fa fa-lightbulb-o mr-1"></i>号码推荐说明：
              </p>
              <ul class="text-blue-700 text-sm space-y-1">
                <li>• <strong>主推号码 ${luckyNumbers.fullNumber}</strong>：基于卦象和五行综合计算</li>
                <li>• <strong>十位数 ${luckyNumbers.tensDigit}</strong>：由上卦${upper.name}和下卦${lower.name}组合得出</li>
                <li>• <strong>个位数 ${luckyNumbers.unitDigit}</strong>：根据${dominantElement}行和动爻第${changingLine}爻确定</li>
                <li>• <strong>备选号码</strong>：${luckyNumbers.alternatives.join('、')} 可作为替补选择</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // 获取选中的刮刮乐
    function getSelectedLotteries() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(checkbox => 
        checkbox.nextElementSibling.textContent.trim()
      );
    }

    // 切换彩票类型
    function switchLotteryType(typeId) {
      currentLotteryType = typeId;
      const typeData = lotteryTypes[typeId];
      
      // 更新按钮状态
      document.querySelectorAll('[id^="type-"]').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      document.getElementById(typeId).classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById(typeId).classList.add('bg-primary', 'text-white', 'shadow-lg');
      
      // 更新位置
      document.getElementById('location').value = typeData.location;
      
      // 更新刮刮乐选项
      updateLotteryOptions(typeData.options);
    }

    // 更新刮刮乐选项
    function updateLotteryOptions(options) {
      const container = document.getElementById('lottery-options');
      container.innerHTML = '';
      
      options.forEach(option => {
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-3 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl cursor-pointer hover:from-blue-50 hover:to-purple-50 transition-all duration-300 border border-gray-200 hover:border-blue-300';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'w-5 h-5 text-primary rounded focus:ring-primary';
        checkbox.checked = true;
        
        const span = document.createElement('span');
        span.className = 'font-medium text-gray-700';
        span.textContent = option;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    }

    // 显示生成结果
    function showGeneratedScript() {
      // 先验证表单
      if (!validateForm()) {
        // 滚动到第一个错误字段
        const firstError = document.querySelector('.border-red-500');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
        return;
      }
      
      const resultContainer = document.getElementById('result-container');
      const generatedText = document.getElementById('generated-text');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      // 显示加载状态
      loadingIndicator.style.opacity = '1';
      loadingIndicator.style.pointerEvents = 'auto';
      
      // 模拟AI分析过程
      setTimeout(() => {
        const script = generateEnhancedScript();
        generatedText.innerHTML = script;
        
        // 显示结果
        resultContainer.style.opacity = '1';
        resultContainer.style.transform = 'scale(1)';
        
        // 隐藏加载状态
        loadingIndicator.style.opacity = '0';
        loadingIndicator.style.pointerEvents = 'none';
        
        // 滚动到结果
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 1500);
    }

    // 复制到剪贴板
    function copyToClipboard() {
      const textToCopy = document.getElementById('generated-text').innerText;
      
      navigator.clipboard.writeText(textToCopy)
        .then(() => {
          const toast = document.getElementById('toast');
          toast.style.transform = 'translateY(0)';
          toast.style.opacity = '1';
          
          setTimeout(() => {
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
          }, 3000);
        })
        .catch(err => {
          console.error('复制失败: ', err);
          alert('复制失败，请手动复制。');
        });
    }

    // 表单验证函数
    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const birthdate = document.getElementById('birthdate').value;
      
      let isValid = true;
      
      // 验证姓名
      if (!name) {
        showFieldError('name', '请输入姓名');
        isValid = false;
      } else {
        hideFieldError('name');
      }
      
      // 验证出生日期
      if (!birthdate) {
        showFieldError('birthdate', '请选择出生日期');
        isValid = false;
      } else {
        hideFieldError('birthdate');
      }
      
      return isValid;
    }
    
    // 显示字段错误
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + '-error');
      
      field.classList.add('border-red-500');
      field.classList.remove('border-gray-200');
      
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }
    
    // 隐藏字段错误
    function hideFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + '-error');
      
      field.classList.remove('border-red-500');
      field.classList.add('border-gray-200');
      
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    }

    // 本地存储功能
    function saveUserData() {
      const userData = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender').value,
        birthdate: document.getElementById('birthdate').value,
        location: document.getElementById('location').value,
        luckyNumber: document.getElementById('lucky_number').value,
        zodiac: document.getElementById('shengxiao').value,
        lotteryType: currentLotteryType
      };
      
      localStorage.setItem('lotteryUserData', JSON.stringify(userData));
    }
    
    function loadUserData() {
      const savedData = localStorage.getItem('lotteryUserData');
      if (savedData) {
        try {
          const userData = JSON.parse(savedData);
          
          document.getElementById('name').value = userData.name || '';
          document.getElementById('gender').value = userData.gender || '男';
          document.getElementById('birthdate').value = userData.birthdate || '2002-10-05';
          document.getElementById('location').value = userData.location || '无锡体彩店';
          document.getElementById('lucky_number').value = userData.luckyNumber || '';
          document.getElementById('shengxiao').value = userData.zodiac || '马';
          
          if (userData.lotteryType) {
            switchLotteryType(userData.lotteryType);
          }
        } catch (e) {
          console.error('加载用户数据失败:', e);
        }
      }
    }

    // 事件绑定
    document.addEventListener('DOMContentLoaded', () => {
      // 初始化界面
      updateLotteryOptions(lotteryTypes[currentLotteryType].options);
      
      // 页面加载时根据出生日期自动计算生肖
      const birthdateInput = document.getElementById('birthdate');
      const zodiacSelect = document.getElementById('shengxiao');
      
      if (birthdateInput.value) {
        const zodiac = calculateZodiac(birthdateInput.value);
        zodiacSelect.value = zodiac;
      }
      
      // 绑定事件
      document.getElementById('generate-btn').addEventListener('click', showGeneratedScript);
      document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
      document.getElementById('type-lottery').addEventListener('click', () => switchLotteryType('type-lottery'));
      document.getElementById('type-fucai').addEventListener('click', () => switchLotteryType('type-fucai'));
      
      // 实时验证姓名
      document.getElementById('name').addEventListener('input', function() {
        if (this.value.trim()) {
          hideFieldError('name');
        }
      });
      
      // 出生日期变化时自动计算生肖
      document.getElementById('birthdate').addEventListener('change', function() {
        const birthDate = this.value;
        if (birthDate) {
          const zodiac = calculateZodiac(birthDate);
          const zodiacSelect = document.getElementById('shengxiao');
          
          // 设置对应的生肖选项
          zodiacSelect.value = zodiac;
          
          // 添加视觉反馈
          zodiacSelect.style.backgroundColor = '#f0f9ff';
          zodiacSelect.style.borderColor = '#3b82f6';
          
          setTimeout(() => {
            zodiacSelect.style.backgroundColor = '';
            zodiacSelect.style.borderColor = '';
          }, 1000);
          
          // 清除错误状态
          hideFieldError('birthdate');
        }
      });
      
      // 全选/全不选
      document.getElementById('select-all').addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      });
      
      document.getElementById('deselect-all').addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      });
      
      // 自动聚焦
      document.getElementById('name').focus();

      // 键盘快捷键
      document.addEventListener('keydown', function(e) {
        // Ctrl+Enter 或 Cmd+Enter 生成推荐
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          showGeneratedScript();
        }
        
        // Ctrl+C 或 Cmd+C 复制结果
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && 
            document.getElementById('result-container').style.opacity === '1') {
          e.preventDefault();
          copyToClipboard();
        }
      });
    });
  </script>
</body>
</html>
