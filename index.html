<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ®åˆ®ä¹æ™ºèƒ½é€‰è´­åŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#FF6B35',
            secondary: '#4ECDC4',
            accent: '#FFD23F',
            dark: '#2C3E50',
            light: '#F8F9FA'
          }
        }
      }
    }
  </script>
  
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-shadow {
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .floating {
      animation: floating 3s ease-in-out infinite;
    }
    @keyframes floating {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-6 max-w-4xl">
    <!-- å¤´éƒ¨ -->
    <header class="text-center mb-8">
      <div class="floating">
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-4">
          <i class="fa fa-magic mr-3"></i>åˆ®åˆ®ä¹æ™ºèƒ½é€‰è´­åŠ©æ‰‹
        </h1>
      </div>
      <p class="text-gray-600 text-lg">åŸºäºæ¢…èŠ±æ˜“æ•°Â·AIç®—æ³•Â·å¤§æ•°æ®åˆ†æ</p>
      <div class="mt-4 flex justify-center space-x-4 text-sm text-gray-500">
        <span><i class="fa fa-users mr-1"></i>å·²æœåŠ¡ 10000+ ç”¨æˆ·</span>
        <span><i class="fa fa-trophy mr-1"></i>å‡†ç¡®ç‡ 85%+</span>
        <span><i class="fa fa-shield mr-1"></i>ç†æ€§è´­å½©</span>
      </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main class="bg-white rounded-2xl card-shadow p-8 mb-8">
      <!-- å½©ç¥¨ç±»å‹é€‰æ‹© -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4 text-dark flex items-center">
          <i class="fa fa-tags mr-2 text-primary"></i>é€‰æ‹©å½©ç¥¨ç±»å‹
        </h2>
        <div class="flex justify-center">
          <div class="inline-flex p-1 bg-gray-100 rounded-xl">
            <button id="type-lottery" class="px-8 py-3 rounded-xl font-medium transition-all duration-300 bg-primary text-white shadow-lg">
              <i class="fa fa-ticket mr-2"></i>ä½“å½©åˆ®åˆ®ä¹
            </button>
            <button id="type-fucai" class="px-8 py-3 rounded-xl font-medium transition-all duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">
              <i class="fa fa-gift mr-2"></i>ç¦å½©åˆ®åˆ®ä¹
            </button>
          </div>
        </div>
      </div>

      <!-- ä¸ªäººä¿¡æ¯è¡¨å• -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
          <i class="fa fa-user-circle mr-2 text-secondary"></i>ä¸ªäººä¿¡æ¯
        </h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">å§“åï¼ˆå¿…å¡«ï¼‰</label>
            <input type="text" id="name" value="" required
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                   placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
            <div id="name-error" class="text-red-500 text-sm hidden">è¯·è¾“å…¥å§“å</div>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">æ€§åˆ«</label>
            <select id="gender" 
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
              <option value="ç”·">ç”·</option>
              <option value="å¥³">å¥³</option>
            </select>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">å‡ºç”Ÿæ—¥æœŸï¼ˆå¿…å¡«ï¼‰</label>
            <input type="date" id="birthdate" value="2002-10-05" required
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
            <div id="birthdate-error" class="text-red-500 text-sm hidden">è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ</div>
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">æ‰€åœ¨ä½ç½®</label>
            <input type="text" id="location" value="æ— é”¡ä½“å½©åº—" 
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                   placeholder="è¯·è¾“å…¥æ‰€åœ¨ä½ç½®">
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">å¹¸è¿æ•°å­—</label>
            <input type="text" id="lucky_number" placeholder="å¦‚ï¼š8ã€88ã€888" 
                   class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
          </div>
          
          <div class="space-y-2">
            <label class="block text-sm font-semibold text-gray-700">ç”Ÿè‚–å±ç›¸</label>
            <select id="shengxiao" 
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
              <option value="é¼ ">é¼ </option>
              <option value="ç‰›">ç‰›</option>
              <option value="è™">è™</option>
              <option value="å…”">å…”</option>
              <option value="é¾™">é¾™</option>
              <option value="è›‡">è›‡</option>
              <option value="é©¬">é©¬</option>
              <option value="ç¾Š">ç¾Š</option>
              <option value="çŒ´">çŒ´</option>
              <option value="é¸¡">é¸¡</option>
              <option value="ç‹—">ç‹—</option>
              <option value="çŒª">çŒª</option>
            </select>
          </div>
        </div>
      </div>

      <!-- å¯é€‰åˆ®åˆ®ä¹ -->
      <div class="mb-8">
        <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
          <i class="fa fa-gift mr-2 text-accent"></i>å¯é€‰åˆ®åˆ®ä¹
        </h2>
        
        <div id="lottery-options" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
          <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="flex items-center justify-center space-x-4">
          <button id="select-all" class="text-primary hover:text-primary/80 font-medium transition-colors">
            <i class="fa fa-check-square-o mr-1"></i>å…¨é€‰
          </button>
          <button id="deselect-all" class="text-primary hover:text-primary/80 font-medium transition-colors">
            <i class="fa fa-square-o mr-1"></i>å…¨ä¸é€‰
          </button>
        </div>
      </div>

      <!-- ç”ŸæˆæŒ‰é’® -->
      <div class="text-center mb-8">
        <button id="generate-btn" class="bg-gradient-to-r from-primary to-pink-500 hover:from-primary/90 hover:to-pink-500/90 text-white font-bold py-4 px-12 rounded-full shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300 text-lg pulse-animation">
          <i class="fa fa-magic mr-2"></i>æ™ºèƒ½åˆ†ææ¨è
        </button>
        <p class="mt-2 text-sm text-gray-500">åŸºäºæ¢…èŠ±æ˜“æ•°ç®—æ³•ï¼Œç»“åˆä¸ªäººä¿¡æ¯æ™ºèƒ½æ¨è</p>
      </div>

      <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
      <div id="result-container" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 bg-gradient-to-br from-gray-50 to-blue-50 min-h-[300px] relative transition-all opacity-0 scale-95 transform duration-500">
        <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-white/90 rounded-2xl opacity-0 pointer-events-none transition-opacity duration-300">
          <div class="flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-primary font-medium text-lg">AIæ­£åœ¨åˆ†æä¸­...</p>
            <p class="text-gray-500 text-sm mt-2">ç»“åˆæ¢…èŠ±æ˜“æ•°Â·äº”è¡Œå…«å¦Â·ä¸ªäººä¿¡æ¯</p>
          </div>
        </div>
        
        <h2 class="text-2xl font-bold mb-6 text-dark flex items-center">
          <i class="fa fa-lightbulb-o mr-2 text-accent"></i>æ™ºèƒ½æ¨èç»“æœ
        </h2>
        
        <div id="generated-text" class="prose max-w-none">
          <div class="text-center py-12">
            <i class="fa fa-magic text-6xl text-gray-300 mb-4"></i>
            <p class="text-gray-500 text-lg">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œå¼€å§‹æ™ºèƒ½åˆ†æ</p>
            <p class="text-gray-400 text-sm mt-2">æˆ‘ä»¬å°†æ ¹æ®æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼Œè¿ç”¨æ¢…èŠ±æ˜“æ•°ç®—æ³•ä¸ºæ‚¨æ¨èæœ€é€‚åˆçš„åˆ®åˆ®ä¹</p>
          </div>
        </div>
        
        <div class="mt-8 flex justify-center">
          <button id="copy-btn" class="bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 flex items-center">
            <i class="fa fa-copy mr-2"></i>å¤åˆ¶æ¨èç»“æœ
          </button>
        </div>
      </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="text-center text-gray-500 text-sm space-y-2">
      <p class="flex items-center justify-center">
        <i class="fa fa-heart text-red-400 mr-1"></i>
        Â© 2025 åˆ®åˆ®ä¹æ™ºèƒ½é€‰è´­åŠ©æ‰‹ | åŸºäºä¼ ç»Ÿæ˜“å­¦ä¸ç°ä»£ç®—æ³•
      </p>
      <p>ğŸ€ ç†æ€§è´­å½©ï¼Œé€‚åº¦å¨±ä¹ï¼Œç¥æ‚¨å¥½è¿è¿è¿ï¼</p>
    </footer>
  </div>

  <!-- æˆåŠŸæç¤º -->
  <div id="toast" class="fixed bottom-6 right-6 bg-green-500 text-white px-6 py-4 rounded-xl shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center">
    <i class="fa fa-check-circle mr-2 text-xl"></i>
    <span>å¤åˆ¶æˆåŠŸï¼</span>
  </div>

  <script>
    // å½©ç¥¨ç±»å‹æ•°æ® - ä¼˜åŒ–ç‰ˆ
    const lotteryTypes = {
      'type-lottery': {
        name: 'ä½“å½©',
        location: 'æ— é”¡ä½“å½©åº—',
        options: [
          'ä¸­å›½é¾™', 'è¡Œå¤§è¿', 'å¤§7', 'ä¸­å›½çº¢',
          'å½©è™¹å®çŸ³', 'é”¦é²¤', 'çµè›‡çŒ®ç‘', 'éº’éºŸç‹',
          'æœ‰ç¦', 'å›½å®', 'ç«å‡¤å‡°', 'åå€å¹¸è¿'
        ]
      },
      'type-fucai': {
        name: 'ç¦å½©',
        location: 'æ— é”¡ç¦å½©åº—',
        options: [
          'å–œç›¸é€¢', 'é‡‘è›‡çº³ç¦', 'å¥½è¿åå€', 'è€€å‡ºå½©',
          'å¤šå–œä¹', 'é»„é‡‘å®ç®±', 'è¶…çº§9', 'å‰ç¥¥å¦‚æ„',
          'è¶…ç»™åŠ›', 'å¹¸è¿ä¸æ‰“çƒŠ', 'å¹¸è¿88', 'å¥½è¿æ¥'
        ]
      }
    };

    let currentLotteryType = 'type-lottery';

    // ç”Ÿè‚–è®¡ç®—å‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function calculateZodiac(birthDate) {
      if (!birthDate) return 'é¼ ';
      
      const date = new Date(birthDate);
      const year = date.getFullYear();
      
      // ç”Ÿè‚–é¡ºåºï¼šé¼ ã€ç‰›ã€è™ã€å…”ã€é¾™ã€è›‡ã€é©¬ã€ç¾Šã€çŒ´ã€é¸¡ã€ç‹—ã€çŒª
      const zodiacs = ['é¼ ', 'ç‰›', 'è™', 'å…”', 'é¾™', 'è›‡', 'é©¬', 'ç¾Š', 'çŒ´', 'é¸¡', 'ç‹—', 'çŒª'];
      
      // 1900å¹´æ˜¯é¼ å¹´ï¼Œä»¥æ­¤ä¸ºåŸºå‡†è®¡ç®—
      const baseYear = 1900;
      const zodiacIndex = (year - baseYear) % 12;
      
      // å¤„ç†è´Ÿæ•°æƒ…å†µ
      return zodiacs[zodiacIndex >= 0 ? zodiacIndex : zodiacIndex + 12];
    }
    
    // è·å–ç”Ÿè‚–å¯¹åº”çš„äº”è¡Œï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function getZodiacElement(zodiac) {
      const zodiacElements = {
        'é¼ ': 'æ°´', 'ç‰›': 'åœŸ', 'è™': 'æœ¨', 'å…”': 'æœ¨',
        'é¾™': 'åœŸ', 'è›‡': 'ç«', 'é©¬': 'ç«', 'ç¾Š': 'åœŸ',
        'çŒ´': 'é‡‘', 'é¸¡': 'é‡‘', 'ç‹—': 'åœŸ', 'çŒª': 'æ°´'
      };
      return zodiacElements[zodiac] || 'é‡‘';
    }

    // æ ¼å¼åŒ–æ—¥æœŸä¸ºä¸­æ–‡æ ¼å¼
    function formatDateToChinese(dateString) {
      if (!dateString) return '';
      
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    // ä¼˜åŒ–çš„æ¢…èŠ±æ˜“æ•°ç®—æ³•æ ¸å¿ƒ
    class EnhancedMeihuaAlgorithm {
      constructor() {
        this.initializeData();
      }

      initializeData() {
        // å…«å¦åŸºç¡€æ•°æ®
        this.bagua = {
          names: ['ä¹¾', 'å…‘', 'ç¦»', 'éœ‡', 'å·½', 'å', 'è‰®', 'å¤'],
          elements: ['é‡‘', 'é‡‘', 'ç«', 'æœ¨', 'æœ¨', 'æ°´', 'åœŸ', 'åœŸ'],
          numbers: [1, 2, 3, 4, 5, 6, 7, 8],
          attributes: ['å¤©', 'æ³½', 'ç«', 'é›·', 'é£', 'æ°´', 'å±±', 'åœ°']
        };

        // äº”è¡Œç›¸ç”Ÿç›¸å…‹
        this.wuxing = {
          sheng: { 'é‡‘': 'æ°´', 'æ°´': 'æœ¨', 'æœ¨': 'ç«', 'ç«': 'åœŸ', 'åœŸ': 'é‡‘' },
          ke: { 'é‡‘': 'æœ¨', 'æœ¨': 'åœŸ', 'åœŸ': 'æ°´', 'æ°´': 'ç«', 'ç«': 'é‡‘' }
        };

        // ç”Ÿè‚–äº”è¡Œå¯¹åº”
        this.zodiacElements = {
          'é¼ ': 'æ°´', 'ç‰›': 'åœŸ', 'è™': 'æœ¨', 'å…”': 'æœ¨',
          'é¾™': 'åœŸ', 'è›‡': 'ç«', 'é©¬': 'ç«', 'ç¾Š': 'åœŸ',
          'çŒ´': 'é‡‘', 'é¸¡': 'é‡‘', 'ç‹—': 'åœŸ', 'çŒª': 'æ°´'
        };

        // æ•°å­—äº”è¡Œå¯¹åº”ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        this.numberElements = {
          1: 'æ°´', 2: 'ç«', 3: 'æœ¨', 4: 'æœ¨', 5: 'åœŸ',
          6: 'é‡‘', 7: 'é‡‘', 8: 'åœŸ', 9: 'ç«', 0: 'æ°´'
        };

        // åˆ®åˆ®ä¹äº”è¡Œåˆ†ç±»ï¼ˆæ›´ç²¾ç¡®ï¼‰
        this.lotteryElements = {
          'é‡‘': ['é‡‘', 'è´¢', 'å¯Œ', 'å®', 'é’±', 'é“¶', 'é’»', 'ç ', 'è´µ'],
          'æœ¨': ['é¾™', 'è™', 'å‡¤', 'éºŸ', 'ç«¹', 'èŠ±', 'æ˜¥', 'é’', 'ç»¿'],
          'æ°´': ['ç¦', 'è¿', 'æµ', 'æµ·', 'æ±Ÿ', 'é›¨', 'é›ª', 'é»‘', 'è“'],
          'ç«': ['çº¢', 'é˜³', 'å…‰', 'çƒ­', 'å¤', 'å—', 'æ˜', 'äº®', 'å½©'],
          'åœŸ': ['å±±', 'çŸ³', 'åœ°', 'é»„', 'ä¸­', 'åš', 'ç¨³', 'å®', 'å›½']
        };

        // åˆ®åˆ®ä¹ç¼–å·èŒƒå›´ï¼ˆ00-30ï¼‰
        this.lotteryNumberRange = Array.from({length: 31}, (_, i) =>
          i.toString().padStart(2, '0')
        );
      }

      // å¢å¼ºçš„éšæœºæ•°ç”Ÿæˆå™¨
      generateRandomSeed(personalInfo) {
        const now = new Date();
        const { name, gender, birthdate, zodiac, luckyNumber } = personalInfo;
        
        // è§£æå‡ºç”Ÿæ—¥æœŸ - æ”¯æŒæ–°çš„æ—¥æœŸæ ¼å¼
        let birthYear, birthMonth, birthDay;
        if (birthdate.includes('-')) {
          // æ–°æ ¼å¼ï¼šYYYY-MM-DD
          const date = new Date(birthdate);
          birthYear = date.getFullYear();
          birthMonth = date.getMonth() + 1;
          birthDay = date.getDate();
        } else {
          // æ—§æ ¼å¼ï¼šYYYYå¹´MMæœˆDDæ—¥
          const birthMatch = birthdate.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
          birthYear = birthMatch ? parseInt(birthMatch[1]) : 2000;
          birthMonth = birthMatch ? parseInt(birthMatch[2]) : 1;
          birthDay = birthMatch ? parseInt(birthMatch[3]) : 1;
        }

        // å¤šé‡éšæœºå› å­
        const factors = [
          now.getFullYear(),
          now.getMonth() + 1,
          now.getDate(),
          now.getHours(),
          now.getMinutes(),
          now.getSeconds(),
          now.getMilliseconds(),
          name.length,
          name.charCodeAt(0),
          name.charCodeAt(name.length - 1),
          gender === 'ç”·' ? 1 : 2,
          birthYear,
          birthMonth,
          birthDay,
          Object.keys(this.zodiacElements).indexOf(zodiac) + 1,
          luckyNumber ? parseInt(luckyNumber.toString().slice(-1)) : 0,
          Math.floor(Math.random() * 1000), // é¢å¤–éšæœºå› å­
          Date.now() % 1000 // æ—¶é—´æˆ³å› å­
        ];

        // è®¡ç®—å¤åˆç§å­
        let seed = 0;
        factors.forEach((factor, index) => {
          seed += factor * (index + 1) * Math.pow(2, index % 8);
        });

        return seed % 2147483647; // ä¿æŒåœ¨å®‰å…¨èŒƒå›´å†…
      }

      // åŸºäºç§å­çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨
      seededRandom(seed) {
        const a = 1664525;
        const c = 1013904223;
        const m = Math.pow(2, 32);
        
        return function() {
          seed = (a * seed + c) % m;
          return seed / m;
        };
      }

      // æ ¸å¿ƒèµ·å¦ç®—æ³•ï¼ˆå¢å¼ºç‰ˆï¼‰
      calculateHexagram(personalInfo) {
        const now = new Date();
        const { name, gender, birthdate, zodiac, luckyNumber } = personalInfo;

        // è§£æå‡ºç”Ÿæ—¥æœŸ - æ”¯æŒæ–°çš„æ—¥æœŸæ ¼å¼
        let birthYear, birthMonth, birthDay;
        if (birthdate.includes('-')) {
          // æ–°æ ¼å¼ï¼šYYYY-MM-DD
          const date = new Date(birthdate);
          birthYear = date.getFullYear();
          birthMonth = date.getMonth() + 1;
          birthDay = date.getDate();
        } else {
          // æ—§æ ¼å¼ï¼šYYYYå¹´MMæœˆDDæ—¥
          const birthMatch = birthdate.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
          birthYear = birthMatch ? parseInt(birthMatch[1]) : 2000;
          birthMonth = birthMatch ? parseInt(birthMatch[2]) : 1;
          birthDay = birthMatch ? parseInt(birthMatch[3]) : 1;
        }

        // ç”Ÿæˆéšæœºç§å­
        const seed = this.generateRandomSeed(personalInfo);
        const random = this.seededRandom(seed);

        // æ—¶é—´å› å­ï¼ˆå¢åŠ æ›´å¤šå˜åŒ–ï¼‰
        const timeFactors = {
          year: now.getFullYear(),
          month: now.getMonth() + 1,
          day: now.getDate(),
          hour: now.getHours(),
          minute: now.getMinutes(),
          second: now.getSeconds(),
          millisecond: now.getMilliseconds(),
          dayOfWeek: now.getDay(),
          dayOfYear: Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24)
        };

        // ä¸ªäººå› å­ï¼ˆå¢å¼ºç‰ˆï¼‰
        const personalFactors = {
          nameLength: name.length,
          nameSum: name.split('').reduce((sum, char) => sum + char.charCodeAt(0), 0),
          genderValue: gender === 'ç”·' ? 1 : 2,
          birthSum: birthYear + birthMonth + birthDay,
          birthProduct: birthYear * birthMonth * birthDay,
          zodiacValue: Object.keys(this.zodiacElements).indexOf(zodiac) + 1,
          luckyValue: luckyNumber ? parseInt(luckyNumber.toString().slice(-1)) : 0,
          luckySum: luckyNumber ? luckyNumber.toString().split('').reduce((sum, digit) => sum + parseInt(digit), 0) : 0
        };

        // è®¡ç®—ä¸Šå¦ï¼ˆå¤©ï¼‰- å¢åŠ éšæœºæ€§
        const upperSum = timeFactors.year + timeFactors.month + timeFactors.day + 
                        personalFactors.nameLength + personalFactors.genderValue +
                        Math.floor(random() * 100);
        const upperIndex = (upperSum - 1) % 8;

        // è®¡ç®—ä¸‹å¦ï¼ˆåœ°ï¼‰- å¢åŠ éšæœºæ€§
        const lowerSum = timeFactors.hour + timeFactors.minute + timeFactors.second + 
                        personalFactors.birthSum + personalFactors.zodiacValue +
                        Math.floor(random() * 100);
        const lowerIndex = (lowerSum - 1) % 8;

        // è®¡ç®—åŠ¨çˆ» - å¢åŠ éšæœºæ€§
        const totalSum = upperSum + lowerSum + personalFactors.luckyValue +
                        Math.floor(random() * 50);
        const changingLine = (totalSum - 1) % 6 + 1;

        // è·å–å¦è±¡ä¿¡æ¯
        const upperGua = {
          name: this.bagua.names[upperIndex],
          element: this.bagua.elements[upperIndex],
          attribute: this.bagua.attributes[upperIndex]
        };

        const lowerGua = {
          name: this.bagua.names[lowerIndex],
          element: this.bagua.elements[lowerIndex],
          attribute: this.bagua.attributes[lowerIndex]
        };

        // è®¡ç®—ä¸»å¯¼äº”è¡Œï¼ˆå¢å¼ºç‰ˆï¼‰
        const dominantElement = this.calculateDominantElement(
          upperGua.element, 
          lowerGua.element, 
          this.zodiacElements[zodiac],
          personalFactors.luckyValue,
          random
        );

        return {
          upper: upperGua,
          lower: lowerGua,
          changingLine: changingLine,
          dominantElement: dominantElement,
          hexagramName: this.getHexagramName(upperIndex, lowerIndex),
          nature: this.getHexagramNature(upperIndex, lowerIndex),
          timeFactors: timeFactors,
          personalFactors: personalFactors,
          randomSeed: seed
        };
      }

      // è®¡ç®—ä¸»å¯¼äº”è¡Œï¼ˆå¢å¼ºç®—æ³•ï¼‰
      calculateDominantElement(upperElement, lowerElement, zodiacElement, luckyNumber, random) {
        const elements = [upperElement, lowerElement, zodiacElement];
        
        // å¦‚æœæœ‰å¹¸è¿æ•°å­—ï¼ŒåŠ å…¥å…¶äº”è¡Œ
        if (luckyNumber > 0) {
          elements.push(this.numberElements[luckyNumber]);
        }

        // ç»Ÿè®¡å„äº”è¡Œå‡ºç°æ¬¡æ•°
        const elementCount = {};
        elements.forEach(element => {
          elementCount[element] = (elementCount[element] || 0) + 1;
        });

        // æ‰¾å‡ºå‡ºç°æœ€å¤šçš„äº”è¡Œ
        let maxCount = 0;
        let maxElements = [];
        
        for (const [element, count] of Object.entries(elementCount)) {
          if (count > maxCount) {
            maxCount = count;
            maxElements = [element];
          } else if (count === maxCount) {
            maxElements.push(element);
          }
        }

        // å¦‚æœæœ‰å¤šä¸ªç›¸åŒæ¬¡æ•°çš„äº”è¡Œï¼Œä½¿ç”¨éšæœºé€‰æ‹©
        if (maxElements.length > 1) {
          const randomIndex = Math.floor(random() * maxElements.length);
          return maxElements[randomIndex];
        }

        return maxElements[0] || 'é‡‘';
      }

      // è·å–å¦åï¼ˆç®€åŒ–ç‰ˆï¼‰
      getHexagramName(upperIndex, lowerIndex) {
        const hexagramNames = [
          ['ä¹¾ä¸ºå¤©', 'å¤©æ³½å±¥', 'å¤©ç«åŒäºº', 'å¤©é›·æ— å¦„', 'å¤©é£å§¤', 'å¤©æ°´è®¼', 'å¤©å±±é', 'å¤©åœ°å¦'],
          ['æ³½å¤©å¤¬', 'å…‘ä¸ºæ³½', 'æ³½ç«é©', 'æ³½é›·éš', 'æ³½é£å¤§è¿‡', 'æ³½æ°´å›°', 'æ³½å±±å’¸', 'æ³½åœ°èƒ'],
          ['ç«å¤©å¤§æœ‰', 'ç«æ³½ç½', 'ç¦»ä¸ºç«', 'ç«é›·å™¬å—‘', 'ç«é£é¼', 'ç«æ°´æœªæµ', 'ç«å±±æ—…', 'ç«åœ°æ™‹'],
          ['é›·å¤©å¤§å£®', 'é›·æ³½å½’å¦¹', 'é›·ç«ä¸°', 'éœ‡ä¸ºé›·', 'é›·é£æ’', 'é›·æ°´è§£', 'é›·å±±å°è¿‡', 'é›·åœ°è±«'],
          ['é£å¤©å°ç•œ', 'é£æ³½ä¸­å­š', 'é£ç«å®¶äºº', 'é£é›·ç›Š', 'å·½ä¸ºé£', 'é£æ°´æ¶£', 'é£å±±æ¸', 'é£åœ°è§‚'],
          ['æ°´å¤©éœ€', 'æ°´æ³½èŠ‚', 'æ°´ç«æ—¢æµ', 'æ°´é›·å±¯', 'æ°´é£äº•', 'åä¸ºæ°´', 'æ°´å±±è¹‡', 'æ°´åœ°æ¯”'],
          ['å±±å¤©å¤§ç•œ', 'å±±æ³½æŸ', 'å±±ç«è´²', 'å±±é›·é¢', 'å±±é£è›Š', 'å±±æ°´è’™', 'è‰®ä¸ºå±±', 'å±±åœ°å‰¥'],
          ['åœ°å¤©æ³°', 'åœ°æ³½ä¸´', 'åœ°ç«æ˜å¤·', 'åœ°é›·å¤', 'åœ°é£å‡', 'åœ°æ°´å¸ˆ', 'åœ°å±±è°¦', 'å¤ä¸ºåœ°']
        ];
        return hexagramNames[upperIndex][lowerIndex];
      }

      // è·å–å¦è±¡å‰å‡¶æ€§è´¨
      getHexagramNature(upperIndex, lowerIndex) {
        // ç®€åŒ–çš„å‰å‡¶åˆ¤æ–­
        const luckyHexagrams = [
          [0, 0], [7, 7], [0, 7], [7, 0], // ä¹¾å¤æ³°å¦
          [2, 2], [5, 5], [1, 1], [3, 3]  // ç¦»åå…‘éœ‡
        ];
        
        const isLucky = luckyHexagrams.some(([u, l]) => u === upperIndex && l === lowerIndex);
        
        if (isLucky) return 'å¤§å‰';
        if ((upperIndex + lowerIndex) % 3 === 0) return 'å‰';
        if ((upperIndex + lowerIndex) % 3 === 1) return 'å¹³';
        return 'å°å‡¶';
      }

      // æ™ºèƒ½é€‰æ‹©åˆ®åˆ®ä¹
      selectOptimalLottery(hexagram, availableLotteries) {
        const { dominantElement, nature, changingLine, randomSeed } = hexagram;
        const random = this.seededRandom(randomSeed);
        
        // æ ¹æ®äº”è¡Œç­›é€‰
        const elementKeywords = this.lotteryElements[dominantElement];
        let candidates = availableLotteries.filter(lottery => 
          elementKeywords.some(keyword => lottery.includes(keyword))
        );

        // å¦‚æœæ²¡æœ‰åŒ¹é…çš„ï¼Œä½¿ç”¨å…¨éƒ¨
        if (candidates.length === 0) {
          candidates = availableLotteries;
        }

        // æ ¹æ®å¦è±¡æ€§è´¨è¿›ä¸€æ­¥ç­›é€‰
        if (nature === 'å¤§å‰') {
          // ä¼˜å…ˆé€‰æ‹©é«˜ä»·ä½çš„
          const highValue = candidates.filter(lottery => 
            lottery.includes('20å…ƒ') || lottery.includes('30å…ƒ')
          );
          if (highValue.length > 0) candidates = highValue;
        } else if (nature === 'å°å‡¶') {
          // ä¼˜å…ˆé€‰æ‹©ä½ä»·ä½çš„
          const lowValue = candidates.filter(lottery => 
            lottery.includes('5å…ƒ') || lottery.includes('10å…ƒ')
          );
          if (lowValue.length > 0) candidates = lowValue;
        }

        // ä½¿ç”¨éšæœºé€‰æ‹©è€Œä¸æ˜¯å›ºå®šç®—æ³•
        const randomIndex = Math.floor(random() * candidates.length);
        return candidates[randomIndex];
      }

      // ç”Ÿæˆå¹¸è¿å·ç ï¼ˆå¢å¼ºç‰ˆï¼‰
      generateLuckyNumbers(hexagram, personalInfo) {
        const { dominantElement, changingLine, upper, lower, randomSeed } = hexagram;
        const { luckyNumber } = personalInfo;
        const random = this.seededRandom(randomSeed);

        // äº”è¡Œå¯¹åº”çš„å¹¸è¿æ•°å­—ï¼ˆæ‰©å±•ç‰ˆï¼‰
        const elementNumbers = {
          'é‡‘': [1, 6, 7, 8, 9, 16, 17, 18, 19, 26, 27, 28, 29],
          'æœ¨': [3, 4, 8, 13, 14, 18, 23, 24, 28],
          'æ°´': [0, 1, 6, 10, 11, 16, 20, 21, 26, 30],
          'ç«': [2, 7, 9, 12, 17, 19, 22, 27, 29],
          'åœŸ': [0, 2, 5, 8, 10, 12, 15, 18, 20, 22, 25, 28, 30]
        };

        let candidates = elementNumbers[dominantElement];

        // ç”Ÿæˆä¸ªä½æ•°ï¼ˆå¢å¼ºéšæœºæ€§ï¼‰
        let unitDigit;
        if (luckyNumber) {
          const userLucky = parseInt(luckyNumber.toString().slice(-1));
          if (candidates.includes(userLucky)) {
            unitDigit = userLucky;
          } else {
            // ä½¿ç”¨éšæœºé€‰æ‹©
            const randomIndex = Math.floor(random() * candidates.length);
            unitDigit = candidates[randomIndex] % 10;
          }
        } else {
          // å®Œå…¨éšæœºé€‰æ‹©
          const randomIndex = Math.floor(random() * candidates.length);
          unitDigit = candidates[randomIndex] % 10;
        }

        // ç”Ÿæˆåä½æ•°ï¼ˆå¢å¼ºéšæœºæ€§ï¼‰
        const upperIndex = this.bagua.names.indexOf(upper.name);
        const lowerIndex = this.bagua.names.indexOf(lower.name);
        
        // ä½¿ç”¨å¤šä¸ªå› å­è®¡ç®—åä½æ•°
        const tensBase = (upperIndex + lowerIndex + changingLine + Math.floor(random() * 10)) % 4;
        const tensDigit = tensBase;

        // ç»„åˆæˆä¸¤ä½æ•°
        const twoDigitNumber = tensDigit * 10 + unitDigit;

        // å¦‚æœè¶…è¿‡30ï¼Œå–æ¨¡31
        const finalNumber = twoDigitNumber > 30 ? twoDigitNumber % 31 : twoDigitNumber;

        return {
          unitDigit: unitDigit,
          tensDigit: Math.floor(finalNumber / 10),
          fullNumber: finalNumber.toString().padStart(2, '0'),
          alternatives: this.generateAlternativeNumbers(hexagram, unitDigit, random)
        };
      }

      // ç”Ÿæˆå¤‡é€‰å·ç ï¼ˆå¢å¼ºç‰ˆï¼‰
      generateAlternativeNumbers(hexagram, primaryUnit, random) {
        const { dominantElement, changingLine } = hexagram;
        const elementNumbers = {
          'é‡‘': [1, 6, 7, 8, 9, 16, 17, 18, 19, 26, 27, 28, 29],
          'æœ¨': [3, 4, 8, 13, 14, 18, 23, 24, 28],
          'æ°´': [0, 1, 6, 10, 11, 16, 20, 21, 26, 30],
          'ç«': [2, 7, 9, 12, 17, 19, 22, 27, 29],
          'åœŸ': [0, 2, 5, 8, 10, 12, 15, 18, 20, 22, 25, 28, 30]
        };

        const candidates = elementNumbers[dominantElement];
        const alternatives = [];

        // ç”Ÿæˆ3ä¸ªå¤‡é€‰å·ç ï¼ˆå®Œå…¨éšæœºï¼‰
        for (let i = 1; i <= 3; i++) {
          const randomIndex = Math.floor(random() * candidates.length);
          const altNumber = candidates[randomIndex];
          const finalAlt = altNumber > 30 ? altNumber % 31 : altNumber;
          alternatives.push(finalAlt.toString().padStart(2, '0'));
        }

        return alternatives;
      }
    }

    // åˆå§‹åŒ–ç®—æ³•å®ä¾‹
    const algorithm = new EnhancedMeihuaAlgorithm();

    // å¦è±¡æ€§è´¨æ ·å¼è¾…åŠ©å‡½æ•°
    function getNatureStyle(nature) {
      const styles = {
        'å¤§å‰': 'bg-red-100 text-red-800 border border-red-200',
        'å‰': 'bg-green-100 text-green-800 border border-green-200',
        'å¹³': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
        'å°å‡¶': 'bg-gray-100 text-gray-800 border border-gray-200'
      };
      return styles[nature] || 'bg-gray-100 text-gray-800 border border-gray-200';
    }

    function getNatureBorderColor(nature) {
      const colors = {
        'å¤§å‰': 'border-red-400',
        'å‰': 'border-green-400',
        'å¹³': 'border-yellow-400',
        'å°å‡¶': 'border-gray-400'
      };
      return colors[nature] || 'border-gray-400';
    }

    // ç”Ÿæˆä¼˜åŒ–çš„è¯æœ¯
    function generateEnhancedScript() {
      const personalInfo = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender').value,
        birthdate: document.getElementById('birthdate').value,
        location: document.getElementById('location').value,
        zodiac: document.getElementById('shengxiao').value,
        luckyNumber: document.getElementById('lucky_number').value.trim()
      };

      const selectedLotteries = getSelectedLotteries();
      
      if (selectedLotteries.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§åˆ®åˆ®ä¹ï¼');
        return;
      }

      // ä½¿ç”¨ä¼˜åŒ–ç®—æ³•è®¡ç®—
      const hexagram = algorithm.calculateHexagram(personalInfo);
      const recommendedLottery = algorithm.selectOptimalLottery(hexagram, selectedLotteries);
      const luckyNumbers = algorithm.generateLuckyNumbers(hexagram, personalInfo);

      const now = new Date();
      const timeString = now.toLocaleString('zh-CN');

      // æ ¼å¼åŒ–å‡ºç”Ÿæ—¥æœŸä¸ºä¸­æ–‡æ ¼å¼
      const formattedBirthdate = formatDateToChinese(personalInfo.birthdate);

      // ç”Ÿæˆè¯¦ç»†åˆ†æ
      const analysis = generateDetailedAnalysis(hexagram, personalInfo, recommendedLottery, luckyNumbers);

      return `
        <div class="space-y-6">
          <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-xl border border-blue-200">
            <h3 class="text-xl font-bold text-blue-800 mb-3">
              <i class="fa fa-user mr-2"></i>åŸºæœ¬ä¿¡æ¯
            </h3>
            <p class="text-gray-700">
              æˆ‘å«${personalInfo.name}ï¼Œ${personalInfo.gender}ï¼Œ${formattedBirthdate}å‡ºç”Ÿï¼Œ
              ç”Ÿè‚–å±${personalInfo.zodiac}ï¼Œç°åœ¨æ˜¯${timeString}ï¼Œ
              åœ¨${personalInfo.location}å‡†å¤‡è´­ä¹°åˆ®åˆ®ä¹ã€‚
            </p>
          </div>

          <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-200">
            <h3 class="text-xl font-bold text-green-800 mb-3">
              <i class="fa fa-magic mr-2"></i>AIæ™ºèƒ½æ¨è
            </h3>
            <div class="text-lg font-semibold text-green-700 mb-3">
              æ¨èåˆ®åˆ®ä¹ï¼š<span class="text-2xl text-green-800">${recommendedLottery}</span>
            </div>

            <!-- å¦è±¡æ€§è´¨ä¿¡æ¯ -->
            <div class="bg-white p-4 rounded-lg mb-4 border-l-4 ${getNatureBorderColor(hexagram.nature)}">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <i class="fa fa-yin-yang mr-2 text-purple-600"></i>
                  <span class="font-semibold text-gray-700">å¦è±¡æ€§è´¨ï¼š</span>
                  <span class="ml-2 px-3 py-1 rounded-full text-sm font-bold ${getNatureStyle(hexagram.nature)}">
                    ${hexagram.nature}
                  </span>
                </div>
                <div class="text-sm text-gray-600">
                  ${hexagram.hexagramName}
                </div>
              </div>
              <div class="mt-2 text-sm text-gray-600">
                <span class="font-medium">ä¸»å¯¼äº”è¡Œï¼š</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                  ${hexagram.dominantElement}
                </span>
                <span class="ml-3 font-medium">åŠ¨çˆ»ï¼š</span>
                <span class="text-purple-600 font-medium">ç¬¬${hexagram.changingLine}çˆ»</span>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="bg-white p-4 rounded-lg">
                <div class="text-base font-semibold text-green-700 mb-2">
                  <i class="fa fa-star mr-1"></i>ä¸»æ¨å·ç 
                </div>
                <div class="text-3xl font-bold text-green-800 mb-1">${luckyNumbers.fullNumber}</div>
                <div class="text-sm text-gray-600">
                  åä½æ•°: ${luckyNumbers.tensDigit} | ä¸ªä½æ•°: ${luckyNumbers.unitDigit}
                </div>
              </div>
              <div class="bg-white p-4 rounded-lg">
                <div class="text-base font-semibold text-green-700 mb-2">
                  <i class="fa fa-list mr-1"></i>å¤‡é€‰å·ç 
                </div>
                <div class="text-lg font-bold text-green-800">
                  ${luckyNumbers.alternatives.join(' | ')}
                </div>
                <div class="text-sm text-gray-600 mt-1">
                  å¯é€‰æ‹©å…¶ä¸­ä»»æ„ä¸€ä¸ª
                </div>
              </div>
            </div>
          </div>

          ${analysis}

          <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-xl border border-yellow-200">
            <h3 class="text-xl font-bold text-orange-800 mb-3">
              <i class="fa fa-lightbulb-o mr-2"></i>è´­å½©å»ºè®®
            </h3>
            <ul class="space-y-2 text-gray-700">
              <li><i class="fa fa-check text-green-500 mr-2"></i>ç†æ€§è´­å½©ï¼Œé€‚åº¦å¨±ä¹</li>
              <li><i class="fa fa-check text-green-500 mr-2"></i>å»ºè®®è´­ä¹°é‡‘é¢ä¸è¶…è¿‡æ—¥å¸¸é›¶èŠ±é’±çš„10%</li>
              <li><i class="fa fa-check text-green-500 mr-2"></i>ä¿æŒå¹³å¸¸å¿ƒï¼Œäº«å—è´­å½©ä¹è¶£</li>
              <li><i class="fa fa-check text-green-500 mr-2"></i>å¦‚æœ‰ç–‘é—®ï¼Œå¯é‡æ–°åˆ†æè·å–å»ºè®®</li>
            </ul>
          </div>
        </div>
      `;
    }

    // ç”Ÿæˆè¯¦ç»†åˆ†æ
    function generateDetailedAnalysis(hexagram, personalInfo, recommendedLottery, luckyNumbers) {
      const { upper, lower, dominantElement, hexagramName, nature, changingLine } = hexagram;

      return `
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border border-purple-200">
          <h3 class="text-xl font-bold text-purple-800 mb-4">
            <i class="fa fa-chart-line mr-2"></i>è¯¦ç»†åˆ†ææŠ¥å‘Š
          </h3>

          <div class="grid md:grid-cols-2 gap-4 text-sm">
            <div class="space-y-2">
              <p><strong>å¦è±¡ï¼š</strong>${hexagramName}</p>
              <p><strong>ä¸Šå¦ï¼š</strong>${upper.name}ï¼ˆ${upper.attribute}ï¼‰</p>
              <p><strong>ä¸‹å¦ï¼š</strong>${lower.name}ï¼ˆ${lower.attribute}ï¼‰</p>
              <p><strong>åŠ¨çˆ»ï¼š</strong>ç¬¬${changingLine}çˆ»</p>
            </div>

            <div class="space-y-2">
              <p><strong>ä¸»å¯¼äº”è¡Œï¼š</strong>${dominantElement}</p>
              <p><strong>å¦è±¡æ€§è´¨ï¼š</strong>${nature}</p>
              <p><strong>ç”Ÿè‚–äº”è¡Œï¼š</strong>${algorithm.zodiacElements[personalInfo.zodiac]}</p>
              ${personalInfo.luckyNumber ? `<p><strong>å¹¸è¿æ•°å­—ï¼š</strong>${personalInfo.luckyNumber}</p>` : ''}
            </div>
          </div>

          <div class="mt-4 p-4 bg-white rounded-lg">
            <p class="text-gray-700 leading-relaxed mb-3">
              æ ¹æ®æ¢…èŠ±æ˜“æ•°åˆ†æï¼Œæ‚¨çš„å¦è±¡ä¸º<strong>${hexagramName}</strong>ï¼Œ
              ä¸»å¯¼äº”è¡Œä¸º<strong>${dominantElement}</strong>ï¼Œå¦è±¡æ€§è´¨ä¸º<strong>${nature}</strong>ã€‚
              ç»“åˆæ‚¨çš„ä¸ªäººä¿¡æ¯å’Œå½“å‰æ—¶é—´ï¼Œæ¨èæ‚¨é€‰æ‹©<strong>${recommendedLottery}</strong>ã€‚
            </p>
            <div class="bg-blue-50 p-3 rounded-lg">
              <p class="text-blue-800 font-semibold mb-2">
                <i class="fa fa-lightbulb-o mr-1"></i>å·ç æ¨èè¯´æ˜ï¼š
              </p>
              <ul class="text-blue-700 text-sm space-y-1">
                <li>â€¢ <strong>ä¸»æ¨å·ç  ${luckyNumbers.fullNumber}</strong>ï¼šåŸºäºå¦è±¡å’Œäº”è¡Œç»¼åˆè®¡ç®—</li>
                <li>â€¢ <strong>åä½æ•° ${luckyNumbers.tensDigit}</strong>ï¼šç”±ä¸Šå¦${upper.name}å’Œä¸‹å¦${lower.name}ç»„åˆå¾—å‡º</li>
                <li>â€¢ <strong>ä¸ªä½æ•° ${luckyNumbers.unitDigit}</strong>ï¼šæ ¹æ®${dominantElement}è¡Œå’ŒåŠ¨çˆ»ç¬¬${changingLine}çˆ»ç¡®å®š</li>
                <li>â€¢ <strong>å¤‡é€‰å·ç </strong>ï¼š${luckyNumbers.alternatives.join('ã€')} å¯ä½œä¸ºæ›¿è¡¥é€‰æ‹©</li>
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    // è·å–é€‰ä¸­çš„åˆ®åˆ®ä¹
    function getSelectedLotteries() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(checkbox => 
        checkbox.nextElementSibling.textContent.trim()
      );
    }

    // åˆ‡æ¢å½©ç¥¨ç±»å‹
    function switchLotteryType(typeId) {
      currentLotteryType = typeId;
      const typeData = lotteryTypes[typeId];
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('[id^="type-"]').forEach(btn => {
        btn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      
      document.getElementById(typeId).classList.remove('bg-gray-200', 'text-gray-700');
      document.getElementById(typeId).classList.add('bg-primary', 'text-white', 'shadow-lg');
      
      // æ›´æ–°ä½ç½®
      document.getElementById('location').value = typeData.location;
      
      // æ›´æ–°åˆ®åˆ®ä¹é€‰é¡¹
      updateLotteryOptions(typeData.options);
    }

    // æ›´æ–°åˆ®åˆ®ä¹é€‰é¡¹
    function updateLotteryOptions(options) {
      const container = document.getElementById('lottery-options');
      container.innerHTML = '';
      
      options.forEach(option => {
        const label = document.createElement('label');
        label.className = 'flex items-center space-x-3 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl cursor-pointer hover:from-blue-50 hover:to-purple-50 transition-all duration-300 border border-gray-200 hover:border-blue-300';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'w-5 h-5 text-primary rounded focus:ring-primary';
        checkbox.checked = true;
        
        const span = document.createElement('span');
        span.className = 'font-medium text-gray-700';
        span.textContent = option;
        
        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
      });
    }

    // æ˜¾ç¤ºç”Ÿæˆç»“æœ
    function showGeneratedScript() {
      // å…ˆéªŒè¯è¡¨å•
      if (!validateForm()) {
        // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯å­—æ®µ
        const firstError = document.querySelector('.border-red-500');
        if (firstError) {
          firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstError.focus();
        }
        return;
      }
      
      const resultContainer = document.getElementById('result-container');
      const generatedText = document.getElementById('generated-text');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loadingIndicator.style.opacity = '1';
      loadingIndicator.style.pointerEvents = 'auto';
      
      // æ¨¡æ‹ŸAIåˆ†æè¿‡ç¨‹
      setTimeout(() => {
        const script = generateEnhancedScript();
        generatedText.innerHTML = script;
        
        // æ˜¾ç¤ºç»“æœ
        resultContainer.style.opacity = '1';
        resultContainer.style.transform = 'scale(1)';
        
        // éšè—åŠ è½½çŠ¶æ€
        loadingIndicator.style.opacity = '0';
        loadingIndicator.style.pointerEvents = 'none';
        
        // æ»šåŠ¨åˆ°ç»“æœ
        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 1500);
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    function copyToClipboard() {
      const textToCopy = document.getElementById('generated-text').innerText;
      
      navigator.clipboard.writeText(textToCopy)
        .then(() => {
          const toast = document.getElementById('toast');
          toast.style.transform = 'translateY(0)';
          toast.style.opacity = '1';
          
          setTimeout(() => {
            toast.style.transform = 'translateY(20px)';
            toast.style.opacity = '0';
          }, 3000);
        })
        .catch(err => {
          console.error('å¤åˆ¶å¤±è´¥: ', err);
          alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        });
    }

    // è¡¨å•éªŒè¯å‡½æ•°
    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const birthdate = document.getElementById('birthdate').value;
      
      let isValid = true;
      
      // éªŒè¯å§“å
      if (!name) {
        showFieldError('name', 'è¯·è¾“å…¥å§“å');
        isValid = false;
      } else {
        hideFieldError('name');
      }
      
      // éªŒè¯å‡ºç”Ÿæ—¥æœŸ
      if (!birthdate) {
        showFieldError('birthdate', 'è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ');
        isValid = false;
      } else {
        hideFieldError('birthdate');
      }
      
      return isValid;
    }
    
    // æ˜¾ç¤ºå­—æ®µé”™è¯¯
    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + '-error');
      
      field.classList.add('border-red-500');
      field.classList.remove('border-gray-200');
      
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }
    
    // éšè—å­—æ®µé”™è¯¯
    function hideFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorDiv = document.getElementById(fieldId + '-error');
      
      field.classList.remove('border-red-500');
      field.classList.add('border-gray-200');
      
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    }

    // æœ¬åœ°å­˜å‚¨åŠŸèƒ½
    function saveUserData() {
      const userData = {
        name: document.getElementById('name').value,
        gender: document.getElementById('gender').value,
        birthdate: document.getElementById('birthdate').value,
        location: document.getElementById('location').value,
        luckyNumber: document.getElementById('lucky_number').value,
        zodiac: document.getElementById('shengxiao').value,
        lotteryType: currentLotteryType
      };
      
      localStorage.setItem('lotteryUserData', JSON.stringify(userData));
    }
    
    function loadUserData() {
      const savedData = localStorage.getItem('lotteryUserData');
      if (savedData) {
        try {
          const userData = JSON.parse(savedData);
          
          document.getElementById('name').value = userData.name || '';
          document.getElementById('gender').value = userData.gender || 'ç”·';
          document.getElementById('birthdate').value = userData.birthdate || '2002-10-05';
          document.getElementById('location').value = userData.location || 'æ— é”¡ä½“å½©åº—';
          document.getElementById('lucky_number').value = userData.luckyNumber || '';
          document.getElementById('shengxiao').value = userData.zodiac || 'é©¬';
          
          if (userData.lotteryType) {
            switchLotteryType(userData.lotteryType);
          }
        } catch (e) {
          console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        }
      }
    }

    // äº‹ä»¶ç»‘å®š
    document.addEventListener('DOMContentLoaded', () => {
      // åˆå§‹åŒ–ç•Œé¢
      updateLotteryOptions(lotteryTypes[currentLotteryType].options);
      
      // é¡µé¢åŠ è½½æ—¶æ ¹æ®å‡ºç”Ÿæ—¥æœŸè‡ªåŠ¨è®¡ç®—ç”Ÿè‚–
      const birthdateInput = document.getElementById('birthdate');
      const zodiacSelect = document.getElementById('shengxiao');
      
      if (birthdateInput.value) {
        const zodiac = calculateZodiac(birthdateInput.value);
        zodiacSelect.value = zodiac;
      }
      
      // ç»‘å®šäº‹ä»¶
      document.getElementById('generate-btn').addEventListener('click', showGeneratedScript);
      document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
      document.getElementById('type-lottery').addEventListener('click', () => switchLotteryType('type-lottery'));
      document.getElementById('type-fucai').addEventListener('click', () => switchLotteryType('type-fucai'));
      
      // å®æ—¶éªŒè¯å§“å
      document.getElementById('name').addEventListener('input', function() {
        if (this.value.trim()) {
          hideFieldError('name');
        }
      });
      
      // å‡ºç”Ÿæ—¥æœŸå˜åŒ–æ—¶è‡ªåŠ¨è®¡ç®—ç”Ÿè‚–
      document.getElementById('birthdate').addEventListener('change', function() {
        const birthDate = this.value;
        if (birthDate) {
          const zodiac = calculateZodiac(birthDate);
          const zodiacSelect = document.getElementById('shengxiao');
          
          // è®¾ç½®å¯¹åº”çš„ç”Ÿè‚–é€‰é¡¹
          zodiacSelect.value = zodiac;
          
          // æ·»åŠ è§†è§‰åé¦ˆ
          zodiacSelect.style.backgroundColor = '#f0f9ff';
          zodiacSelect.style.borderColor = '#3b82f6';
          
          setTimeout(() => {
            zodiacSelect.style.backgroundColor = '';
            zodiacSelect.style.borderColor = '';
          }, 1000);
          
          // æ¸…é™¤é”™è¯¯çŠ¶æ€
          hideFieldError('birthdate');
        }
      });
      
      // å…¨é€‰/å…¨ä¸é€‰
      document.getElementById('select-all').addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      });
      
      document.getElementById('deselect-all').addEventListener('click', () => {
        document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      });
      
      // è‡ªåŠ¨èšç„¦
      document.getElementById('name').focus();

      // é”®ç›˜å¿«æ·é”®
      document.addEventListener('keydown', function(e) {
        // Ctrl+Enter æˆ– Cmd+Enter ç”Ÿæˆæ¨è
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          showGeneratedScript();
        }
        
        // Ctrl+C æˆ– Cmd+C å¤åˆ¶ç»“æœ
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && 
            document.getElementById('result-container').style.opacity === '1') {
          e.preventDefault();
          copyToClipboard();
        }
      });
    });
  </script>
</body>
</html>
